\section{Geometric Consequences of Abstraction}
\label{sec:instantiations}
We now instantiate our general framework %of the previous section 
with
the indexing theory of \autoref{sec:motivating-examples}, and present
more general and formally-justified free theorems, type
isomorphisms, and non-definability results.

%\begin{example}[Two-dimensional Geometry] 

We define the model $\mathcal{M}$ of the indexing theory for the two-dimensional
geometry instantiation as follows. Each of the sorts is interpreted just as
its semantic counterpart: $\semSort{\SynTransl{2}}M = \Transl{2}$, $
\semSort{\SynGL{2}}M = \GL{2}$, $ \semSort{\SynOrth{2}}M = \Orth{2}$,
and $ \semSort{\SynGL{1}}M = \GL{1}$.
%  \begin{displaymath}
%    \begin{array}{@{}llll}
%      \semSort{\SynTransl{2}} = \Transl{2}
%      &
%      \semSort{\SynGL{2}} = \GL{2}
%      &
%      \semSort{\SynOrth{2}} = \Orth{2}
%      &
%      \semSort{\SynGL{1}} = \GL{1}
%    \end{array}
%  \end{displaymath}
Each of the index operations (e.g.,~the group structure and
determinant) is interpreted by the intended semantic operation, and
clearly satisfy the axioms in \exref{ex:two-dim-geo-axioms}. For the
relational interpretations $\mathcal{R}$ of $\tyPrim{vec}{B,t}$ and
$\tyPrim{real}{s}$, we use $\mathcal{R}_{\tyPrimNm{vec}}(B,\vec{t}) = \{
(\vec{v}, B\vec{v} + \vec{t}) \sepbar \vec{v} \in \mathbb{R}^2 \}$ and
$\mathcal{R}_{\tyPrimNm{real}}(k) = \{ (x, kx) \sepbar x \in \mathbb{R} \}$. The
types of the primitive vector operations presented in
\autoref{sec:motivating-examples} are collected into a context
$\Gamma_\Geom$ with a straightforward interpretation $\eta_\Geom \in
\ctxtSem{\Gamma_\Geom}$.
  % \begin{displaymath}
  %   \begin{array}{l}
  %     R_{\tyPrimNm{vec}}(B,\vec{t}) = \{ (\vec{v}, B\vec{v} + \vec{t}) \sepbar \vec{v} \in \mathbb{R}^2 \} \\
  %     R_{\tyPrimNm{real}}(k) = \{ (x, kx) \sepbar x \in \mathbb{R} \}
  %   \end{array}
  % \end{displaymath}
%   The definitions of $R_{\tyPrimNm{vec}}$ and $R_{\tyPrimNm{real}}$
%   %are as expected. % given the informal definitions we gave in
% formalise the informal ones from~\autoref{sec:motivating-examples}, and 
%   the definitions of %We have set
%   $R^\bullet_{\tyPrimNm{vec}}$ and $R^\bullet_{\tyPrimNm{real}}$ 
%   %to relate $\vec{0}$ and $0$ to themselves to 
%   account for the
%   polymorphic zero constants we have assumed.
%\end{example}

\begin{lemma}\label{lem:geom-environments-1}
  For all $\Delta$ and $\rho \in \semSort{\Delta}M$, $(\eta_\Geom,\eta_\Geom) \in \rsem{\Gamma_\Geom}{\relEnv{E}_\Geom}\rho$.
\end{lemma}

\subsection{Free Theorems}
\label{sec:theorems-for-free}

Consider the type of the triangle area %of a triangle 
function from
\exref{ex:area-of-triangle-1}:
\begin{displaymath}
  \begin{array}{@{}l}
    \mathrm{area} : \forall B\mathord:\SynGL{2}, t\mathord:\SynTransl{2}.\ \\
    \hspace{0.8cm}\tyPrim{vec}{B, t} \to \tyPrim{vec}{B, t} \to \tyPrim{vec}{B, t} \to \tyPrim{real}{\abs{\det B}}
  \end{array}
\end{displaymath}
By \thmref{thm:abstraction}, we can derive the following free theorem. For all $B \in \GL{2}$, $\vec{t} \in \Transl{2}$, and $\vec{x}, \vec{y}, \vec{z} \in \mathbb{R}^2$, we have 
\begin{displaymath}
  \abs{\det B}(\tmSem{\mathrm{area}}\ \vec{x}\ \vec{y}\ \vec{z}) = \tmSem{\mathrm{area}}\ (B\vec{x} + \vec{t})\ (B\vec{y} + \vec{t})\ (B\vec{z} + \vec{t})
\end{displaymath}
Thus, directly from the type of the $\mathrm{area}$ function, we can
see that its index-erasure semantics is (a) invariant under
translations, and (b) if the inputs are subjected to a linear
transformation $B$, the output varies with the absolute value of the
determinant of $B$.



% Wadler's influential ``Theorems for Free!''  \cite{wadler89theorems}
% emphasised a particular aspect of Reynolds' theory of relational
% parametricity: the fact that we can read off theorems about a program
% simply by looking at the relational interpretation of its type. We now
% state some free theorems that are derivable in each of the three main
% examples we introduced in \autoref{sec:motivating-examples}.

\subsection{Type Isomorphisms}
\label{sec:types-indexed-abelian-groups}
We say that two types $A$ and $B$ are isomorphic, and write $A \cong
B$, if there exist maps between them that are mutually inverse with
respect to contextual equivalence, i.e., if there are terms $\vdash I
: A \to B$ and $\vdash J : B\to A$ such that $\ctxteq{\cdot}{x:A}{J(I(x))}{x}{A}$ 
and $\ctxteq{\cdot}{y:B}{I(J(y))} y B$.
%\[
%x:A\vdash J(I(x))\stackrel{ctx}\approx x : A
%\text{ and }y:B\vdash I(J(y))\stackrel{ctx}\approx y : B.
%\]
That $\cong$ is a congruence relation on types is straightforward. We
can also derive isomorphisms that are independent of the indexing
theory, such as $A\times B \cong B \times A$, and $\forall
i\mathord:s.A\to B\cong A\to\forall i\mathord:s.B$ for $i$ not free in
$A$.

Types indexed by abelian groups induce a particularly rich theory of
type isomorphisms; previous work on
units-of-measure~\cite{kennedy97relational} relates these to
Buckingham's theorem from dimensional analysis. Here we consider the
additive abelian groups of translations and the multiplicative abelian
group of scalings.

\paragraph{Translations} 
Consider first the group $\Transl{2}$ of translations from
\autoref{sec:type-system-geom-intro} and 
\autoref{sec:affine-vector-ops}. For any quantifier-free type $A$
we have: % the isomorphism:
\begin{eqnarray*}
\forall t\mathord:\SynTransl{2}.\tyPrim{vec}{t}\to A
& \cong &
A[0/t]
\end{eqnarray*}
where $A[0/t]$ denotes substitution of the identity translation $0$
for index variable $t$ in type $A$. This isomorphism formalises the
equivalence between \emph{coordinate-free} geometry, expressed by a
polymorphic type whose first argument can be thought of as the
\emph{origin} with respect to which $A$ is specified, and a
\emph{coordinate-based} geometry, expressed by the type $A[0/t]$, in
which the origin is fixed at $(0,0)$. It is sometimes said that an
affine space is a vector space that has forgotten its origin; we have
captured this in a type isomorphism.

\exref{ex:type-iso} is a special case of this isomorphism; another instance is the
type of vector addition:
\begin{eqnarray*}
\forall t_1\mathord:\SynTransl{2}.\forall t_2\mathord:\SynTransl{2}.\tyPrim{vec}{t_1}\to\tyPrim{vec}{t_2}\to\tyPrim{vec}{t_1+t_2}\\
\cong\quad
\forall t_1\mathord:\SynTransl{2}.\tyPrim{vec}{t_1}\to\tyPrim{vec}{t_1}\quad\cong\quad
\tyPrim{vec}{0}
\end{eqnarray*}
\noindent
\newcommand{\transup}[1]{\mathord\uparrow_{#1}}
\newcommand{\transdn}[1]{\mathord\downarrow_{#1}}
The maps associated with the isomorphism are 
$I = \lambda x. x\ [0]\ 0$ and $J = \lambda y. \Lambda t.\lambda v. \transup A (y)$,
%\begin{eqnarray*}
%I = \lambda x. x\ [0]\ 0 & \text{ and } &
%J = \lambda y. \Lambda t.\ \lambda v. \trans A v t(y)
%\end{eqnarray*}
where terms $\transdn A : A\to A[0/t]$ and $\transup A : A[0/t] \to A$ are defined by induction over the syntax of $A$ (cases omitted for $\transup A$ have definition symmetric to $\transdn A$):
\begin{align*}
\transdn{\tyPrimNm{unit}} &= \lambda x. x \qquad
\transdn{A_1\times A_2} = \lambda p. (\transdn{A_1}(\pi_1 p),\transdn{A_2}(\pi_2 p))\\ 
\transdn{A_1 + A_2} &= \lambda x.
\textrm{case}\ x\ \textrm{of}\ \textrm{inl}\ y.\textrm{inl}(\transdn{A_1}y); \textrm{inr}\ y.\textrm{inr}(\transdn{A_2}y)\\ 
\transdn{A_1\to A_2} &= \lambda f. \lambda x. \transdn{A_2} (f(\transup{A_1}x))\\ 
\transdn{\tyPrim{vec}{e}} &= \lambda x. x - kv \qquad
\transup{\tyPrim{vec}{e}} = \lambda x. x + kv\\ 
\text{ if }e & \equiv k t + e' \text{ for
  some }k\in\setOfIntegers \text{ and }e'\text{ with }t\notin e'
\end{align*}
To show $I(J(y))$ is contextually equivalent to $y$ is an easy
induction on $A$ using the fact that the vector $0$
is an identity for vector addition. To show $J(I(x))$ is contextually
equivalent to $x$ we must apply the abstraction theorem and use
the fact that $\tmSem{\transup A}$ and $\tmSem{\transdn A}$ 
considered as relations are simply instances of $\rsem A{}{}$.
%\[
%$\rsem A {t \mapsto v} {} = \{ (x, \tmSem{\transup A (x)}) \mid x \in
%\tySem A\}$.
%\]

\paragraph{Scalings}
For the group $\GL{1}$ of scalings we can treat
a real-valued argument to a function as a unit-of-measure with
which to scale the result. 
%The small fly in the ointment is that the
Although the argument might be zero, and this cannot be used for scaling,
%Nevertheless, 
we still can obtain the following slightly more complicated
isomorphism:
\begin{eqnarray*}
\forall s\mathord:\SynGL{1}.\tyPrim{real}{s}\to A
& \cong &
A[1/s]\times \forall s\mathord:\SynGL{1}.A
\end{eqnarray*}
The type of $\mathrm{areaCircle}$ from the introduction is one instance:
\begin{eqnarray*}
\forall s\mathord:\SynGL{1}.\tyPrim{real}{s}\to\tyPrim{real}{s\cdot
  s}\\ \quad\cong\quad \tyPrim{real}{1}\times(\forall
s\mathord:\SynGL{1}.\tyPrim{real}{s\cdot s})\\ \quad\cong\quad
\tyPrim{real}{1}\times 1\quad\cong\quad \tyPrim{real}{1}
\end{eqnarray*}
%where %the isomorphism 
The abstraction theorem is used to prove
$\forall s\mathord:\SynGL{1}.\tyPrim{real}{s\cdot s}\cong 1$.
% is proved using
%the abstraction theorem.

%\begin{enumerate}
%\item Two cases: when we have a total ``division'' operation, and when
%  we don't.
%\item Type isomorphisms, based on Smith Normal Form
% \item Non-definability results, based on the non-compositional
%   relational environments
% \item Alteration of the non-definability results in the light of
%   addition of a square root operation
% \item Mention the variation we can obtain by changing some types,
%   e.g. the type of $\mathrm{abs}$. Also, the complex numbers example.
%\end{enumerate}

\subsection{Non-definability}
\label{sec:types-indexed-abelian-groups-indef}

\newcommand{\Grp}{\mathit{Gr}}

For proving non-definability results, we consider the general case of
a sort $\mathsf{G}$ with the equational theory of abelian groups. We
assume a group-indexed primitive type $\tyPrimNm{G}$ and set of
primitive operations typed by $\Gamma_\Grp$ that include the group
identity $1:\tyPrim{G}{1}$, operation $(\cdot): \forall
a,b\mathord:\mathsf{G}.\ \tyPrim{G}{a} \to \tyPrim{G}{b} \to
\tyPrim{G}{a\cdot b}$ and inverse $\ ^{-1}: \forall
a\mathord:\mathsf{G}.\ \tyPrim{G}{a} \to \tyPrim{G}{a^{-1}}$. The
context $\Gamma_\Grp$ may also include members with types of the form
$\forall \vec{a}\mathord:\mathsf{G}.\ \tyPrim{G}{e_1} \to ...
\tyPrim{G}{e_n} \to \tyPrim{G}{e}$ as long as the result index $e$ is
generated by the set $\{e_1,...,e_n\}$. One instance is the
sort~$\SynTransl{2}$ with $0$, $(+)$ and $\mathrm{negate}$ on
$\tyPrim{vec}{t}$. For the purposes of non-definability results, we
may choose an arbitrary index-erasure semantics with $\eta_\Grp \in
\ctxtSem{\Gamma_\Grp}$.

We use the construction of definability relational environments
from \autoref{sec:constr-rel-env}, with $R^\bullet_{\tyPrimNm{G}} =
\emptyset$, to give a pre-substitutive family $\relEnv{E}_\Grp$. This
gives us the following lemma and theorem.

\begin{lemma}\label{lem:geom-environments-2}
  For all $\Delta$ and $\rho \in \relEnv{E}_\Grp(\Delta)$,
  $(\eta_\Grp,\eta_\Grp) \in \rsem{\Gamma_\Grp}{\relEnv{E}_\Grp}\rho$.
\end{lemma}

% For index-erasure interpretation, we assume a (not necessarily
% abelian) group $(G, 1, \cdot, \ ^{-1})$. Let $Z(G)$ be the centre of
% the $G$ %: i.e.,~the set of elements that commute with every other
% %element in $G$. We set 
% and $\tyPrimSem{G} = G$. For each index context $\Delta$, the set
% $\relEnv{E}_\Grp(\Delta)$ of relational environments is defined to be
% $\{ \rho_{(H,h)} \sepbar H\textrm{ is a subgroup of }(\Delta
% \Rightarrow \mathsf{G})/\equiv, h\textrm{ is a group homomorphism }H
% \to Z(G) \}$, where
% \begin{displaymath}
%   \rho_{(H,h)}\ \tyPrimNm{G}\ (e) = \left\{
%     \begin{array}{ll}
%       \{ \} & \textrm{if}\ e\not\in H \\
%       \{ (x, h(e)\oplus x) \sepbar x \in G \} & \textrm{if}\ e\in H
%     \end{array}
%   \right.
% \end{displaymath}


Writing $i^n$ for $n$-fold iteration of the group operation, we have:
\begin{theorem}
  Let $m$ and $n$ be natural numbers. For all $n$-by-$m$-matrices of
  natural numbers $A$ and $m$-by-$1$ matricies of integers $\vec{b}$,
  there exists a quantifier-free program $M$ such that:
  \begin{displaymath}
    i_1,\dots,i_m\mathord:\mathsf{G}; \Gamma_\Grp \vdash M : \tyPrim{G}{e_1} \to \dots \to \tyPrim{G}{e_n} \to \tyPrim{G}{e}
  \end{displaymath}
  where $e_j = i_1^{A_{j1}}\cdots i_m^{A_{jm}}$ and $e = i_1^{b_1}\cdots i_m^{b_m}$, iff there is a solution $\vec{x}$
  in the integers to the equation $A \vec x = \vec{b}$.
\end{theorem}
The uninhabited type $\forall t \mathord: \SynTransl{2}.\
\tyPrim{vec}{t + t} \to \tyPrim{vec}{t}$ from
\exref{ex:uninhabited-type} is an instance of this theorem.  For types
indexed by the scaling group $\SynGL{1}$ the situation is more subtle,
as we have assumed that the type $\tyPrim{real}{s}$ has a polymorphic zero
(see \autoref{fig:real-ops}). We can show, nonetheless, that $\forall
s \mathord: \SynGL{1}.\ \tyPrim{real}{s^2} \to \tyPrim{real}{s}$ is
only inhabited by the constantly zero function by setting
$R^\bullet_{\tyPrimNm{real}} = \{(0,0)\}$. If we augment our sort
$\SynGL{1}$ with a square root operation $s^{1/2}$, then it is
possible to add a primitive square root function and still be able to
prove that the cube root type $\forall s \mathord: \SynGL{1}.\
\tyPrim{real}{s^3} \to \tyPrim{real}{s}$ is only inhabited by the
constantly zero function. This is a consequence of the impossibility
of generating $s$ from $s^3$ with only the abelian group operations
and square root.

%\begin{proof}
%  (If) The program $\Lambda i_1\dots i_m.\ \lambda g_1\dots g_n.\
%  g_1^{x_1}\dots g_n^{x_n}$ satisfies the typing judgment
%  (\ref{eq:fo-group-type}).

%  (Only if) Assume that there is a program $M$ satisfying the typing
%  judgment (\ref{eq:fo-group-type}). By \thmref{thm:abstraction} we
%  know that for all relational environments $\rho \in
%  \relEnv{E}_\Grp(i_1,\dots,i_m)$, and all $g_j,g'_j \in G$,
%  \begin{displaymath}
%    \begin{array}{l}
%      (g_1,g'_1) \in \rho\ \tyPrimNm{G}\ (e_1) \land \dots \land (g_n,g'_n) \in \rho\ \tyPrimNm{G}\ (e_n) \Rightarrow \\
%      \quad (\tmSem{M}g_1\dots g_n, \tmSem{M}g'_1\dots g'_n) \in \rho\ \tyPrimNm{G}\ (e)
%    \end{array}
%  \end{displaymath}
%  We select the relational environments
%  \begin{displaymath}
%    \rho\ \tyPrimNm{G}\ (e) = \left\{
%      \begin{array}{ll}
%        \{(g,g) \sepbar g \in \mathcal{G} \} &
%        \begin{array}[t]{@{}l}
%          \textrm{if}\ e = e_1^{x_1}\dots e_n^{x_n} \\
%          \textrm{ for some }x_1,\dots,x_n \in \mathbb{Z}
%        \end{array}
%        \\
%        \{\} & \textrm{otherwise}
%      \end{array}
%    \right.
%  \end{displaymath}
%  Now, for any $g_1,\dots,g_m \in \mathcal{G}$, we know that, for all
%  $j$, $(g_j,g_j) \in \rho\ \tyPrimNm{G}\ (e_j)$, so we know that
%  $(\tySem{M}g_1\dots g_n, \tySem{M}g_1 \dots g_n) \in \rho\
%  \tyPrimNm{G}\ (e)$. Thus there exist integers $x_1,...,x_n$ such
%  that $e = e_1^{x_1}\dots e_n^{x_n}$. But we also know that $e =
%  i_1^{b_1}...i_m^{b_m}$. By the cancellation property of free groups,
%  we learn that $x_1,...,x_n$ is the solution we need.
%\end{proof}

%%% Local Variables:
%%% TeX-master: "paper"
%%% End:
